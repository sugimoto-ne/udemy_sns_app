{{define "password_resets/index.html"}}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - ç®¡ç†ç”»é¢</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
    <!-- Header -->
    <nav class="navbar is-dark" role="navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="/admin/dashboard">
                <strong>SNSç®¡ç†ç”»é¢</strong>
            </a>
        </div>
        <div class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="tag is-light">{{.AdminUsername}}</span>
                </div>
                <div class="navbar-item">
                    <form action="/admin/logout" method="POST">
                        <button class="button is-light is-small" type="submit">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <div class="columns is-gapless">
        <!-- Sidebar -->
        <aside class="column is-2 has-background-light" style="min-height: calc(100vh - 52px);">
            <aside class="menu p-4">
                <p class="menu-label">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</p>
                <ul class="menu-list">
                    <li><a href="/admin/dashboard" class="{{if eq .Active "dashboard"}}is-active{{end}}">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
                    <li><a href="/admin/users" class="{{if eq .Active "users"}}is-active{{end}}">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
                    <li><a href="/admin/password-resets" class="{{if eq .Active "password-resets"}}is-active{{end}}">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</a></li>
                    <li><a href="/admin/logs" class="{{if eq .Active "logs"}}is-active{{end}}">ğŸ“‹ æ“ä½œãƒ­ã‚°</a></li>
                </ul>
            </aside>
        </aside>

        <!-- Main Content -->
        <div class="column">
            <section class="section">
                <!-- Breadcrumb -->
                <nav class="breadcrumb" aria-label="breadcrumbs">
                    <ul>
                        {{range .Breadcrumbs}}
                        <li class="{{if .Active}}is-active{{end}}">
                            <a href="{{.URL}}">{{.Name}}</a>
                        </li>
                        {{end}}
                    </ul>
                </nav>

                <!-- Page Content -->
<h1 class="title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”³è«‹</h1>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
<div class="box">
    <div class="field is-grouped">
        <div class="control">
            <div class="select">
                <select id="status-filter">
                    <option value="all">å…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                    <option value="pending">æ‰¿èªå¾…ã¡</option>
                    <option value="approved">æ‰¿èªæ¸ˆã¿</option>
                </select>
            </div>
        </div>
        <div class="control">
            <button class="button is-primary" onclick="loadRequests()">æ¤œç´¢</button>
        </div>
    </div>
</div>

<!-- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ« -->
<div class="box">
    <table class="table is-fullwidth is-striped is-hoverable">
        <thead>
            <tr>
                <th>ID</th>
                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                <th>ãƒ¡ãƒ¼ãƒ«</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>ç”³è«‹æ—¥æ™‚</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="requests-table-body">
            <tr>
                <td colspan="6" class="has-text-centered">èª­ã¿è¾¼ã¿ä¸­...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
<nav class="pagination is-centered" role="navigation" id="pagination">
</nav>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒªã‚»ãƒƒãƒˆURLè¡¨ç¤ºï¼‰ -->
<div id="reset-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆURL</p>
            <button class="delete" aria-label="close" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã“ã®URLã‚’é€ä¿¡ã—ã¦ãã ã•ã„ï¼š</strong></p>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input class="input" type="text" id="reset-url" readonly>
                    </div>
                    <div class="control">
                        <button class="button is-info" onclick="copyURL()">ã‚³ãƒ”ãƒ¼</button>
                    </div>
                </div>
                <p><strong>ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼š</strong></p>
                <textarea class="textarea" id="email-template" rows="10" readonly></textarea>
                <button class="button is-success" onclick="copyEmailTemplate()">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </footer>
    </div>
</div>

<script>
async function loadRequests(page = 1) {
    const status = document.getElementById('status-filter').value;

    const params = new URLSearchParams({
        status,
        page,
        limit: 20
    });

    const response = await fetch(`/admin/api/password-resets?${params}`);
    const result = await response.json();
    const data = result.data;

    const tbody = document.getElementById('requests-table-body');
    tbody.innerHTML = '';

    if (data.requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="has-text-centered">ç”³è«‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>';
        return;
    }

    data.requests.forEach(req => {
        const tr = document.createElement('tr');
        const statusClass = req.status === 'approved' ? 'is-success' : req.status === 'pending' ? 'is-warning' : 'is-danger';
        tr.innerHTML = `
            <td>${req.id}</td>
            <td>${req.user ? req.user.username : 'N/A'}</td>
            <td>${req.user ? req.user.email : 'N/A'}</td>
            <td><span class="tag ${statusClass}">${req.status}</span></td>
            <td>${new Date(req.created_at).toLocaleString('ja-JP')}</td>
            <td>
                ${req.status === 'pending' ? `<button class="button is-small is-primary" onclick="approveRequest(${req.id})">æ‰¿èª</button>` : '-'}
            </td>
        `;
        tbody.appendChild(tr);
    });

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆçœç•¥ - users/index.htmlã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
}

async function approveRequest(requestId) {
    if (!confirm('ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”³è«‹ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ')) return;

    const response = await fetch(`/admin/api/password-resets/${requestId}/approve`, {
        method: 'POST'
    });

    if (response.ok) {
        const result = await response.json();
        const data = result.data;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æƒ…å ±ã‚’è¡¨ç¤º
        document.getElementById('reset-url').value = data.reset_url;
        document.getElementById('email-template').value = data.email_template;
        document.getElementById('reset-modal').classList.add('is-active');

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†èª­ã¿è¾¼ã¿
        loadRequests();
    } else {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

function closeModal() {
    document.getElementById('reset-modal').classList.remove('is-active');
}

function copyURL() {
    const input = document.getElementById('reset-url');
    input.select();
    document.execCommand('copy');
    alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}

function copyEmailTemplate() {
    const textarea = document.getElementById('email-template');
    textarea.select();
    document.execCommand('copy');
    alert('ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}

document.addEventListener('DOMContentLoaded', () => {
    loadRequests();
});
</script>

            </section>
        </div>
    </div>

    <script src="/static/js/admin.js"></script>
</body>
</html>
{{end}}
