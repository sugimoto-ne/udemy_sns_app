{{define "users/index.html"}}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - ç®¡ç†ç”»é¢</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
    <!-- Header -->
    <nav class="navbar is-dark" role="navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="/admin/dashboard">
                <strong>SNSç®¡ç†ç”»é¢</strong>
            </a>
        </div>
        <div class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="tag is-light">{{.AdminUsername}}</span>
                </div>
                <div class="navbar-item">
                    <form action="/admin/logout" method="POST">
                        <button class="button is-light is-small" type="submit">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <div class="columns is-gapless">
        <!-- Sidebar -->
        <aside class="column is-2 has-background-light" style="min-height: calc(100vh - 52px);">
            <aside class="menu p-4">
                <p class="menu-label">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</p>
                <ul class="menu-list">
                    <li><a href="/admin/dashboard" class="{{if eq .Active "dashboard"}}is-active{{end}}">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
                    <li><a href="/admin/users" class="{{if eq .Active "users"}}is-active{{end}}">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
                    <li><a href="/admin/password-resets" class="{{if eq .Active "password-resets"}}is-active{{end}}">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</a></li>
                    <li><a href="/admin/logs" class="{{if eq .Active "logs"}}is-active{{end}}">ğŸ“‹ æ“ä½œãƒ­ã‚°</a></li>
                </ul>
            </aside>
        </aside>

        <!-- Main Content -->
        <div class="column">
            <section class="section">
                <!-- Breadcrumb -->
                <nav class="breadcrumb" aria-label="breadcrumbs">
                    <ul>
                        {{range .Breadcrumbs}}
                        <li class="{{if .Active}}is-active{{end}}">
                            <a href="{{.URL}}">{{.Name}}</a>
                        </li>
                        {{end}}
                    </ul>
                </nav>

                <!-- Page Content -->
<h1 class="title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h1>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
<div class="box">
    <div class="field is-grouped">
        <div class="control">
            <div class="select">
                <select id="status-filter">
                    <option value="all">å…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                    <option value="pending">æ‰¿èªå¾…ã¡</option>
                    <option value="approved">æ‰¿èªæ¸ˆã¿</option>
                    <option value="rejected">æ‹’å¦æ¸ˆã¿</option>
                </select>
            </div>
        </div>
        <div class="control">
            <div class="select">
                <select id="role-filter">
                    <option value="all">å…¨ã¦ã®ãƒ­ãƒ¼ãƒ«</option>
                    <option value="user">ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                    <option value="admin">ç®¡ç†è€…</option>
                </select>
            </div>
        </div>
        <div class="control is-expanded">
            <input class="input" type="text" id="search-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢">
        </div>
        <div class="control">
            <button class="button is-primary" onclick="loadUsers()">æ¤œç´¢</button>
        </div>
    </div>
</div>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« -->
<div class="box">
    <table class="table is-fullwidth is-striped is-hoverable">
        <thead>
            <tr>
                <th>ID</th>
                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                <th>ãƒ¡ãƒ¼ãƒ«</th>
                <th>ãƒ­ãƒ¼ãƒ«</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>æŠ•ç¨¿æ•°</th>
                <th>ç™»éŒ²æ—¥æ™‚</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="users-table-body">
            <tr>
                <td colspan="8" class="has-text-centered">èª­ã¿è¾¼ã¿ä¸­...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
<nav class="pagination is-centered" role="navigation" id="pagination">
</nav>

<script>
let currentPage = 1;

async function loadUsers(page = 1) {
    const status = document.getElementById('status-filter').value;
    const role = document.getElementById('role-filter').value;
    const search = document.getElementById('search-input').value;

    const params = new URLSearchParams({
        status,
        role,
        search,
        page,
        limit: 20
    });

    const response = await fetch(`/admin/api/users?${params}`);
    const result = await response.json();
    const data = result.data;

    const tbody = document.getElementById('users-table-body');
    tbody.innerHTML = '';

    if (data.users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>';
        return;
    }

    data.users.forEach(user => {
        const tr = document.createElement('tr');
        const statusClass = user.status === 'approved' ? 'is-success' : user.status === 'pending' ? 'is-warning' : 'is-danger';
        tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td><span class="tag">${user.role}</span></td>
            <td><span class="tag ${statusClass}">${user.status}</span></td>
            <td>${user.post_count}</td>
            <td>${new Date(user.created_at).toLocaleDateString('ja-JP')}</td>
            <td>
                <a href="/admin/users/${user.id}" class="button is-small is-info">è©³ç´°</a>
            </td>
        `;
        tbody.appendChild(tr);
    });

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
    renderPagination(data.pagination);
}

function renderPagination(pagination) {
    const nav = document.getElementById('pagination');
    nav.innerHTML = '';

    if (pagination.total_pages <= 1) return;

    // å‰ã¸ãƒœã‚¿ãƒ³
    const prevLi = document.createElement('li');
    const prevLink = document.createElement('a');
    prevLink.className = 'pagination-previous';
    prevLink.textContent = 'å‰ã¸';
    prevLink.disabled = pagination.page === 1;
    if (pagination.page > 1) {
        prevLink.onclick = () => loadUsers(pagination.page - 1);
    }
    nav.appendChild(prevLink);

    // æ¬¡ã¸ãƒœã‚¿ãƒ³
    const nextLink = document.createElement('a');
    nextLink.className = 'pagination-next';
    nextLink.textContent = 'æ¬¡ã¸';
    nextLink.disabled = pagination.page === pagination.total_pages;
    if (pagination.page < pagination.total_pages) {
        nextLink.onclick = () => loadUsers(pagination.page + 1);
    }
    nav.appendChild(nextLink);

    // ãƒšãƒ¼ã‚¸ç•ªå·
    const ul = document.createElement('ul');
    ul.className = 'pagination-list';
    for (let i = 1; i <= Math.min(pagination.total_pages, 10); i++) {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.className = 'pagination-link' + (i === pagination.page ? ' is-current' : '');
        a.textContent = i;
        a.onclick = () => loadUsers(i);
        li.appendChild(a);
        ul.appendChild(li);
    }
    nav.appendChild(ul);
}

document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
});
</script>

            </section>
        </div>
    </div>

    <script src="/static/js/admin.js"></script>
</body>
</html>
{{end}}
