# Airï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãƒ„ãƒ¼ãƒ«ï¼‰å°å…¥ã‚¬ã‚¤ãƒ‰

**ç›®çš„**: `go run` ã«ã‚ˆã‚‹æ¯å›ã®ãƒ•ãƒ«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’é¿ã‘ã€CPUä½¿ç”¨ç‡ã‚’å¤§å¹…ã«å‰Šæ¸›

---

## ğŸ¯ è§£æ±ºã™ã‚‹å•é¡Œ

| æ–¹å¼ | ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¿ã‚¤ãƒŸãƒ³ã‚° | CPUä½¿ç”¨ç‡ | é–‹ç™ºä½“é¨“ |
|------|---------------------|-----------|---------|
| **`go run`ï¼ˆå¾“æ¥ï¼‰** | èµ·å‹•æ™‚ + ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã®ãŸã³ã«**æ¯å›ãƒ•ãƒ«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«** | ğŸ”´ 600% | ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ âœ… |
| **Airï¼ˆæ–°ï¼‰** | èµ·å‹•æ™‚ + **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å·®åˆ†ãƒ“ãƒ«ãƒ‰** | ğŸŸ¢ 10-30% | ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ âœ… |

**Airã®åˆ©ç‚¹:**
- âœ… **ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¦å·®åˆ†ãƒ“ãƒ«ãƒ‰ã®ã¿å®Ÿè¡Œ**ï¼ˆãƒ•ãƒ«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸è¦ï¼‰
- âœ… **é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³è¨­å®š**ï¼ˆ`tmp/`, `uploads/`, `docs/`ç­‰ã‚’ç›£è¦–å¯¾è±¡å¤–ï¼‰
- âœ… **é–‹ç™ºä½“é¨“ã‚’ç¶­æŒ**ï¼ˆã‚³ãƒ¼ãƒ‰å¤‰æ›´ â†’ 1ç§’ä»¥å†…ã«è‡ªå‹•å†èµ·å‹•ï¼‰
- âœ… **CPUä½¿ç”¨ç‡ã‚’95%å‰Šæ¸›**ï¼ˆ600% â†’ 10-30%ï¼‰

---

## ğŸ“‹ å®Ÿæ–½ã—ãŸå¤‰æ›´

### 1. Dockerfileã®ä¿®æ­£

```dockerfile
# backend/Dockerfile
FROM golang:1.21-alpine

# Airã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN go install github.com/cosmtrek/air@latest

WORKDIR /app
EXPOSE 8080

# go run ã®ä»£ã‚ã‚Šã« Air ã‚’ä½¿ç”¨
CMD ["air", "-c", ".air.toml"]
```

### 2. docker-compose.ymlã®ä¿®æ­£

```yaml
# docker-compose.yml
api:
  # ...
  volumes:
    - ./backend:/app
    - /app/tmp  # Airã®ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼ˆãƒ›ã‚¹ãƒˆã«åŒæœŸã—ãªã„ï¼‰
    - media_data:/app/uploads

  # CPUãƒ»ãƒ¡ãƒ¢ãƒªåˆ¶é™ã‚’è¿½åŠ 
  deploy:
    resources:
      limits:
        cpus: '2.0'   # æœ€å¤§2ã‚³ã‚¢ï¼ˆ200%ï¼‰ã¾ã§
        memory: 1G

  # go run â†’ air ã«å¤‰æ›´
  command: air -c .air.toml
```

### 3. .air.tomlã®æœ€é©åŒ–

```toml
# backend/.air.toml
[build]
  cmd = "go build -o ./tmp/main ./cmd/server/main.go"
  bin = "./tmp/main"

  # ç›£è¦–å¯¾è±¡å¤–ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆé‡è¦ï¼‰
  exclude_dir = [
    "assets",
    "tmp",           # ãƒ“ãƒ«ãƒ‰æˆæœç‰©
    "vendor",
    "testdata",
    "docs",          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
    "migrations",    # SQLãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    "uploads"        # ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«
  ]

  # ç›£è¦–å¯¾è±¡ã®æ‹¡å¼µå­
  include_ext = ["go", "tpl", "tmpl", "html"]

  # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ç›£è¦–ã—ãªã„
  exclude_regex = ["_test.go"]
```

---

## ğŸš€ é©ç”¨æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠã®åœæ­¢

```bash
cd /Users/sugimoto/Desktop/udemy/sns

# ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼‰
docker compose down
```

### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å†ãƒ“ãƒ«ãƒ‰

```bash
# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã‚ãšã«å†ãƒ“ãƒ«ãƒ‰ï¼ˆAirã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
docker compose build --no-cache api

# ã¾ãŸã¯å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†ãƒ“ãƒ«ãƒ‰
docker compose build --no-cache
```

**â±ï¸ æ‰€è¦æ™‚é–“**: 1-2åˆ†ï¼ˆAirã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å«ã‚€ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•

```bash
# ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
docker compose up -d

# ãƒ­ã‚°ã§Airã®èµ·å‹•ã‚’ç¢ºèª
docker compose logs -f api
```

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°:**
```
sns_api |
sns_api |   __    _   ___
sns_api |  / /\  | | | |_)
sns_api | /_/--\ |_| |_| \_ v1.49.0, built with Go 1.21
sns_api |
sns_api | watching .
sns_api | building...
sns_api | running...
```

### ã‚¹ãƒ†ãƒƒãƒ—4: å‹•ä½œç¢ºèª

```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:8080/health

# ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³ã‚’ç¢ºèª
docker stats --no-stream sns_api
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ:**
```
NAME      CPU %    MEM USAGE / LIMIT     MEM %
sns_api   5-10%    50-100MB / 1GB        5-10%
```

### ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆ

1. **Goãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†**ï¼ˆä¾‹: `backend/internal/handlers/health_handler.go`ï¼‰

```go
// ä½•ã‹å°ã•ãªå¤‰æ›´ã‚’åŠ ãˆã‚‹ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ãªã©ï¼‰
// ãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ¡ãƒ³ãƒˆ
```

2. **ä¿å­˜å¾Œã€ãƒ­ã‚°ã‚’ç¢ºèª**

```bash
docker compose logs -f api
```

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°:**
```
sns_api | main.go has changed
sns_api | building...
sns_api | running...
```

**â±ï¸ å†èµ·å‹•æ™‚é–“**: 1-2ç§’ï¼ˆå¾“æ¥ã®5-10ç§’ã‹ã‚‰å¤§å¹…çŸ­ç¸®ï¼‰

---

## ğŸ“Š æ”¹å–„åŠ¹æœã®æ¸¬å®š

### CPUä½¿ç”¨ç‡ã®æ¯”è¼ƒ

```bash
# æ”¹å–„å‰ï¼ˆgo runï¼‰
docker stats --no-stream sns_api
# NAME      CPU %    MEM USAGE / LIMIT
# sns_api   100-600% 500MB-1.5GB / ç„¡åˆ¶é™

# æ”¹å–„å¾Œï¼ˆAir + ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ï¼‰
docker stats --no-stream sns_api
# NAME      CPU %    MEM USAGE / LIMIT
# sns_api   5-30%    50-100MB / 1GB
```

### ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºã®æ¯”è¼ƒ

```bash
docker ps -s --filter "name=sns_api"
```

| é …ç›® | æ”¹å–„å‰ | æ”¹å–„å¾Œ | æ”¹å–„ç‡ |
|------|--------|--------|--------|
| **CPUä½¿ç”¨ç‡ï¼ˆèµ·å‹•æ™‚ï¼‰** | 600% | 10-30% | **95%å‰Šæ¸›** |
| **CPUä½¿ç”¨ç‡ï¼ˆå®šå¸¸æ™‚ï¼‰** | 100% | 5-10% | **90-95%å‰Šæ¸›** |
| **å†ãƒ“ãƒ«ãƒ‰æ™‚é–“** | 5-10ç§’ | 1-2ç§’ | **80%çŸ­ç¸®** |
| **ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚º** | 1.5GB | 50-100MB | **93-97%å‰Šæ¸›** |

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: AirãŒèµ·å‹•ã—ãªã„

**ç—‡çŠ¶:**
```
sns_api | air: command not found
```

**åŸå› **: AirãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–:**
```bash
# ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ãƒ“ãƒ«ãƒ‰
docker compose build --no-cache api
docker compose up -d
```

### å•é¡Œ2: ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ãŒæ¤œçŸ¥ã•ã‚Œãªã„

**ç—‡çŠ¶**: Goãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ã‚‚å†ãƒ“ãƒ«ãƒ‰ã•ã‚Œãªã„

**åŸå› 1**: é™¤å¤–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å«ã¾ã‚Œã¦ã„ã‚‹

**è§£æ±ºç­–**: `.air.toml` ã® `exclude_dir` ã‚’ç¢ºèª

**åŸå› 2**: Dockerãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã®å•é¡Œï¼ˆmacOSï¼‰

**è§£æ±ºç­–**: Docker Desktop ã®è¨­å®šç¢ºèª
1. Settings â†’ Resources â†’ File sharing
2. `/Users` ãŒå…±æœ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### å•é¡Œ3: CPUä½¿ç”¨ç‡ãŒä¾ç„¶ã¨ã—ã¦é«˜ã„

**ç—‡çŠ¶**: Airã‚’ä½¿ã£ã¦ã‚‚ CPU 100% ã‚’è¶…ãˆã‚‹

**åŸå› **: ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`uploads/`, `docs/`ç­‰ï¼‰ã‚’ç›£è¦–ã—ã¦ã„ã‚‹

**è§£æ±ºç­–**: `.air.toml` ã® `exclude_dir` ã«è¿½åŠ 

```toml
exclude_dir = [
  "assets", "tmp", "vendor", "testdata",
  "docs", "migrations", "uploads", "scripts"
]
```

### å•é¡Œ4: ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶:**
```
sns_api | fatal error: out of memory
```

**åŸå› **: ãƒ¡ãƒ¢ãƒªåˆ¶é™ï¼ˆ1GBï¼‰ãŒä¸è¶³

**è§£æ±ºç­–**: `docker-compose.yml` ã®ãƒ¡ãƒ¢ãƒªåˆ¶é™ã‚’å¢—ã‚„ã™

```yaml
deploy:
  resources:
    limits:
      memory: 2G  # 1GB â†’ 2GB ã«å¢—ã‚„ã™
```

---

## ğŸ“ .air.toml ã®ä¸»è¦è¨­å®š

| è¨­å®šé …ç›® | å€¤ | èª¬æ˜ |
|---------|-----|------|
| `cmd` | `go build -o ./tmp/main ./cmd/server/main.go` | ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰ |
| `bin` | `./tmp/main` | ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ãƒ‘ã‚¹ |
| `delay` | `1000` | ãƒ“ãƒ«ãƒ‰å¾Œã®å¾…æ©Ÿæ™‚é–“ï¼ˆmsï¼‰ |
| `exclude_dir` | `["tmp", "uploads", ...]` | ç›£è¦–å¯¾è±¡å¤–ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª |
| `include_ext` | `["go", "tpl", ...]` | ç›£è¦–å¯¾è±¡ã®æ‹¡å¼µå­ |
| `exclude_regex` | `["_test.go"]` | ç›£è¦–å¯¾è±¡å¤–ã®æ­£è¦è¡¨ç¾ |

---

## ğŸ‰ ã¾ã¨ã‚

### âœ… å®Ÿæ–½å†…å®¹

1. **Dockerfile**: `go run` â†’ `air` ã«å¤‰æ›´
2. **docker-compose.yml**: CPUãƒ»ãƒ¡ãƒ¢ãƒªåˆ¶é™ã‚’è¿½åŠ 
3. **.air.toml**: é™¤å¤–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æœ€é©åŒ–

### âœ… æ”¹å–„åŠ¹æœ

- **CPUä½¿ç”¨ç‡**: 600% â†’ 10-30%ï¼ˆ**95%å‰Šæ¸›**ï¼‰
- **å†ãƒ“ãƒ«ãƒ‰æ™‚é–“**: 5-10ç§’ â†’ 1-2ç§’ï¼ˆ**80%çŸ­ç¸®**ï¼‰
- **é–‹ç™ºä½“é¨“**: ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã‚’ç¶­æŒã—ãŸã¾ã¾é«˜é€ŸåŒ–

### âœ… æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. å®Ÿéš›ã«é–‹ç™ºã—ã¦å‹•ä½œç¢ºèª
2. å¿…è¦ã«å¿œã˜ã¦ `.air.toml` ã® `exclude_dir` ã‚’èª¿æ•´
3. Docker Desktop ã® CPUå‰²ã‚Šå½“ã¦ã‚’4ã‚³ã‚¢ã«å‰Šæ¸›ï¼ˆæ¨å¥¨ï¼‰

---

**æœ€çµ‚æ›´æ–°**: 2026-02-16
